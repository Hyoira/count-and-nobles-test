<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Count and Nobles (Online)</title>
    <style>
        /* CSSã¯AIå¯¾æˆ¦ç‰ˆã‹ã‚‰å¤‰æ›´ã‚ã‚Šã¾ã›ã‚“ãŒã€ãƒ­ãƒ“ãƒ¼ç”»é¢ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ ã—ã¦ã„ã¾ã™ */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Orbitron:wght@400;700&display=swap');
        :root {
            --bg-color: #1a1a1a; --text-color: #e0e0e0; --primary-color: #d4af37;
            --secondary-color: #4a0e0e; --card-bg: #2c2c2c; --card-border: #444;
            --font-main: 'Noto Serif JP', serif; --font-timer: 'Orbitron', sans-serif;
        }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: var(--font-main); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        .container { width: 95%; max-width: 1200px; height: 95vh; border: 2px solid var(--primary-color); border-radius: 15px; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); box-shadow: 0 0 30px rgba(212, 175, 55, 0.5); }
        
        /* --- ãƒ­ãƒ“ãƒ¼ã‚¹ã‚¿ã‚¤ãƒ« --- */
        #lobby { padding: 40px; text-align: center; }
        #lobby h1 { font-size: 3rem; color: var(--primary-color); }
        #lobby p { font-size: 1.2rem; margin: 20px 0; }
        .lobby-actions button, .lobby-actions input { font-family: var(--font-main); font-size: 1.2rem; padding: 10px 20px; margin: 10px; border-radius: 8px; border: 2px solid var(--primary-color); background-color: transparent; color: var(--primary-color); cursor: pointer; transition: all 0.3s; }
        .lobby-actions button:hover { background-color: var(--primary-color); color: var(--bg-color); }
        .lobby-actions input { text-align: center; color: var(--text-color); }
        #game-id-display { margin-top: 30px; font-size: 1.5rem; }
        #game-id-display span { font-family: var(--font-timer); background: #000; padding: 5px 15px; border-radius: 5px; cursor: pointer; }

        /* --- ã‚²ãƒ¼ãƒ ç”»é¢ã‚¹ã‚¿ã‚¤ãƒ« (AIç‰ˆã¨åŒæ§˜) --- */
        .game-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .top-area { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .timer-container { text-align: center; }
        #timer { font-family: var(--font-timer); font-size: clamp(4rem, 15vw, 8rem); color: var(--primary-color); text-shadow: 0 0 15px var(--primary-color); transition: all 0.2s ease; }
        .gun-area { position: absolute; font-size: 5rem; opacity: 0; transition: opacity 0.5s ease; cursor: pointer; filter: drop-shadow(0 0 10px #fff); }
        .gun-area.active { opacity: 1; }
        #message-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.85); padding: 30px 50px; border: 2px solid var(--primary-color); border-radius: 10px; text-align: center; z-index: 100; font-size: 2rem; box-shadow: 0 0 20px rgba(0,0,0,0.7); }
        #message-box h2 { margin: 0 0 15px 0; color: var(--primary-color); }
        #restart-button { margin-top: 20px; padding: 10px 20px; font-size: 1rem; cursor: pointer; background-color: var(--primary-color); color: var(--bg-color); border: none; border-radius: 5px; font-family: var(--font-main); font-weight: bold; transition: all 0.3s ease; }
        .players-area { display: flex; justify-content: space-between; padding: 20px; gap: 20px; }
        .player-container { flex: 1; display: flex; flex-direction: column; border: 1px solid var(--card-border); border-radius: 10px; padding: 15px; background: rgba(44, 44, 44, 0.5); }
        .player-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .player-name { font-size: 1.5rem; font-weight: bold; }
        .deck-info { font-size: 1.2rem; }
        .cooldown-bar { width: 100%; height: 5px; background-color: #444; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .cooldown-progress { width: 100%; height: 100%; background-color: var(--primary-color); transition: width 0.1s linear; }
        .hand { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; min-height: 180px; }
        .card { background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: 10px; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .card:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-color: var(--primary-color); }
        .card.disabled { cursor: not-allowed; opacity: 0.5; filter: grayscale(80%); }
        .card-name { font-weight: bold; font-size: 1rem; color: var(--primary-color); padding-top: 15px; }
        .card-desc { font-size: 0.8rem; flex-grow: 1; margin-top: 5px; }
        .card-info { font-size: 0.7rem; text-align: right; opacity: 0.7; }
        .card-key-hint { position: absolute; top: 5px; left: 10px; font-size: 1.2rem; font-weight: bold; font-family: var(--font-timer); color: rgba(255, 255, 255, 0.4); }
    </style>
</head>
<body>

<div class="container">
    <!-- ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ­ãƒ“ãƒ¼ç”»é¢ã®ä½œæˆ -->
    <div id="lobby">
        <h1>Count and Nobles</h1>
        <p>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ã§å¯¾æˆ¦ã™ã‚‹</p>
        <div class="lobby-actions">
            <button id="create-game-btn">ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆ</button>
            <input type="text" id="join-game-input" placeholder="ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›">
            <button id="join-game-btn">ãƒ«ãƒ¼ãƒ ã«å‚åŠ </button>
        </div>
        <div id="game-id-display"></div>
        <p id="lobby-status"></p>
    </div>

    <!-- ã‚²ãƒ¼ãƒ ç”»é¢ (æœ€åˆã¯éè¡¨ç¤º) -->
    <div id="game-container" class="game-container" style="display: none;">
        <div class="top-area">
            <div class="timer-container">
                <div id="timer">10.00</div>
            </div>
            <div id="gun" class="gun-area">ğŸ”«</div>
        </div>
        <div id="message-box" style="display: none;"></div>
        <div class="players-area">
            <div class="player-container" id="player1-container">
                <div class="player-info">
                    <span class="player-name" id="player1-name">Player 1</span>
                    <span class="deck-info" id="deck-count-1">Deck: 10</span>
                </div>
                <div class="hand" id="hand-1"></div>
                <div class="cooldown-bar"><div class="cooldown-progress" id="cooldown-progress-1"></div></div>
            </div>
            <div class="player-container" id="player2-container">
                <div class="player-info">
                    <span class="player-name" id="player2-name">Player 2</span>
                    <span class="deck-info" id="deck-count-2">Deck: 10</span>
                </div>
                <div class="hand" id="hand-2"></div>
                <div class="cooldown-bar"><div class="cooldown-progress" id="cooldown-progress-2"></div></div>
            </div>
        </div>
    </div>
</div>

<!-- ã‚¹ãƒ†ãƒƒãƒ—4: Firebase SDKã®èª­ã¿è¾¼ã¿ -->
<script type="module">
    // Firebase SDKã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã—ã¾ã™
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- ã“ã“ã«ã€ã‚¹ãƒ†ãƒƒãƒ—1ã§ã‚³ãƒ”ãƒ¼ã—ãŸã‚ãªãŸã®firebaseConfigã‚’è²¼ã‚Šä»˜ã‘ã¾ã™ ---
    const firebaseConfig = {
      apiKey: "AIzaSyBR4AcKo_D26DHF8zeHlW6KBSge6nPEYvw",
      authDomain: "count-and-nobles-test.firebaseapp.com",
      projectId: "count-and-nobles-test",
      storageBucket: "count-and-nobles-test.firebasestorage.app",
      messagingSenderId: "944479168462",
      appId: "1:944479168462:web:ffa8c678d0f3a729b5ad9f"
    };
    // --------------------------------------------------------------------

    // Firebaseã®åˆæœŸåŒ–
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DOM Elements ---
    const lobbyEl = document.getElementById('lobby');
    const gameContainerEl = document.getElementById('game-container');
    const createGameBtn = document.getElementById('create-game-btn');
    const joinGameBtn = document.getElementById('join-game-btn');
    const joinGameInput = document.getElementById('join-game-input');
    const gameIdDisplay = document.getElementById('game-id-display');
    const lobbyStatus = document.getElementById('lobby-status');
    // (ã‚²ãƒ¼ãƒ ç”»é¢ã®DOMè¦ç´ ã¯AIç‰ˆã¨åŒæ§˜)
    const timerEl = document.getElementById('timer');
    const gunEl = document.getElementById('gun');
    const messageBoxEl = document.getElementById('message-box');

    // --- Game State (ãƒ­ãƒ¼ã‚«ãƒ«) ---
    let localGameState = {
        gameId: null,
        playerId: null, // 1 or 2
        unsubscribe: null, // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç›£è¦–ã‚’åœæ­¢ã™ã‚‹ãŸã‚ã®é–¢æ•°
        timerInterval: null,
    };
    
    // --- ã‚«ãƒ¼ãƒ‰å®šç¾© (AIç‰ˆã¨åŒæ§˜) ---
    const allCards = [
        { id: 1, name: "åŠ é€Ÿ", desc: "2ç§’é–“ã€æ™‚é–“ã®æµã‚ŒãŒ2å€ã«ãªã‚‹ã€‚", type: "time", gcd: 3 },
        { id: 2, name: "æ¸›é€Ÿ", desc: "3ç§’é–“ã€æ™‚é–“ã®æµã‚ŒãŒåŠåˆ†ã«ãªã‚‹ã€‚", type: "time", gcd: 4 },
        { id: 3, name: "è·³èº", desc: "æ™‚é–“ã‚’2ç§’é€²ã‚ã‚‹ã€‚", type: "time", gcd: 2 },
        { id: 4, name: "å›å¸°", desc: "æ™‚é–“ã‚’1.5ç§’æˆ»ã™ã€‚", type: "time", gcd: 3 },
        { id: 5, name: "å¹»æƒ‘", desc: "2ç§’é–“ã‚¿ã‚¤ãƒãƒ¼ã‚’éš ã™ã€‚", type: "meta", gcd: 5 },
        { id: 6, name: "å½ã‚Šã®åˆå›³", desc: "ãƒ©ãƒ³ãƒ€ãƒ ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ã§å½ã®éŠƒã‚’å‡ºç¾ã•ã›ã‚‹ã€‚", type: "meta", gcd: 4 },
        { id: 7, name: "æŸç¸›", desc: "ç›¸æ‰‹ã¯2ç§’é–“ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ãˆãªã„ã€‚", type: "special", gcd: 5 },
        { id: 8, name: "æ‰‹æœ­äº¤æ›", desc: "è‡ªåˆ†ã®æ‰‹æœ­ã‚’å…¨ã¦äº¤æ›ã™ã‚‹ã€‚", type: "special", gcd: 2 },
    ];

    // --- ã‚¹ãƒ†ãƒƒãƒ—5: ãƒ­ãƒ“ãƒ¼æ©Ÿèƒ½ã®å®Ÿè£… ---
    
    // ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆã™ã‚‹
    createGameBtn.onclick = async () => {
        lobbyStatus.textContent = "ãƒ«ãƒ¼ãƒ ã‚’ä½œæˆä¸­...";
        const gameId = Math.random().toString(36).substring(2, 7).toUpperCase(); // ãƒ©ãƒ³ãƒ€ãƒ ãªIDã‚’ç”Ÿæˆ
        localGameState.gameId = gameId;
        localGameState.playerId = 1;

        const initialDeck = createDeck();
        const initialHand = [];
        for(let i=0; i<3; i++) initialHand.push(initialDeck.pop());

        // Firestoreã«ä¿å­˜ã™ã‚‹åˆæœŸã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
        const gameData = {
            status: 'waiting', // waiting, playing, finished
            timer: 10,
            timerSpeed: 1,
            isSignalActive: false,
            winner: null,
            players: {
                '1': { name: 'Player 1', deck: initialDeck, hand: initialHand, gcd: 0, maxGcd: 0 },
                '2': null // 2äººç›®ã®ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã¯ã¾ã ã„ãªã„
            }
        };

        try {
            await setDoc(doc(db, "games", gameId), gameData);
            gameIdDisplay.innerHTML = `ãƒ«ãƒ¼ãƒ ID: <span onclick="copyToClipboard('${gameId}')">${gameId}</span> (ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚³ãƒ”ãƒ¼)`;
            lobbyStatus.textContent = "ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®å‚åŠ ã‚’å¾…ã£ã¦ã„ã¾ã™...";
            listenToGameUpdates(gameId);
        } catch (e) {
            console.error("Error creating game: ", e);
            lobbyStatus.textContent = "ãƒ«ãƒ¼ãƒ ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚";
        }
    };

    // ãƒ«ãƒ¼ãƒ ã«å‚åŠ ã™ã‚‹
    joinGameBtn.onclick = async () => {
        const gameId = joinGameInput.value.toUpperCase();
        if (!gameId) {
            lobbyStatus.textContent = "ãƒ«ãƒ¼ãƒ IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚";
            return;
        }
        lobbyStatus.textContent = "ãƒ«ãƒ¼ãƒ ã«å‚åŠ ä¸­...";
        const gameRef = doc(db, "games", gameId);
        const gameSnap = await getDoc(gameRef);

        if (gameSnap.exists()) {
            const gameData = gameSnap.data();
            if (gameData.players['2']) {
                lobbyStatus.textContent = "ã“ã®ãƒ«ãƒ¼ãƒ ã¯æº€å“¡ã§ã™ã€‚";
                return;
            }
            
            localGameState.gameId = gameId;
            localGameState.playerId = 2;

            const initialDeck = createDeck();
            const initialHand = [];
            for(let i=0; i<3; i++) initialHand.push(initialDeck.pop());

            // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼2ã®æƒ…å ±ã‚’è¿½åŠ ã—ã€ã‚²ãƒ¼ãƒ ã‚’é–‹å§‹çŠ¶æ…‹ã«ã™ã‚‹
            await updateDoc(gameRef, {
                'players.2': { name: 'Player 2', deck: initialDeck, hand: initialHand, gcd: 0, maxGcd: 0 },
                status: 'playing'
            });

            listenToGameUpdates(gameId);

        } else {
            lobbyStatus.textContent = "æŒ‡å®šã•ã‚ŒãŸIDã®ãƒ«ãƒ¼ãƒ ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚";
        }
    };

    // --- ã‚¹ãƒ†ãƒƒãƒ—6: ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åŒæœŸã®å®Ÿè£… ---
    function listenToGameUpdates(gameId) {
        lobbyEl.style.display = 'none';
        gameContainerEl.style.display = 'flex';

        localGameState.unsubscribe = onSnapshot(doc(db, "games", gameId), (docSnap) => {
            if (!docSnap.exists()) return;
            const gameData = docSnap.data();
            
            // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å¤‰æ›´ã‚’UIã«åæ˜ 
            updateUI(gameData);

            // ã‚²ãƒ¼ãƒ ã®çŠ¶æ…‹ã«å¿œã˜ãŸå‡¦ç†
            if (gameData.status === 'playing' && localGameState.playerId === 1 && !localGameState.timerInterval) {
                // Player1 (ãƒ›ã‚¹ãƒˆ) ã®ã¿ãŒã‚¿ã‚¤ãƒãƒ¼ã‚’é€²ã‚ã‚‹å‡¦ç†ã‚’è¡Œã†
                localGameState.timerInterval = setInterval(() => {
                    updateTimer(gameData);
                }, 10);
            }
            
            if (gameData.status === 'finished') {
                if(localGameState.timerInterval) clearInterval(localGameState.timerInterval);
                localGameState.timerInterval = null;
                // å‹æ•—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸è¡¨ç¤º
                const winnerPlayer = gameData.players[gameData.winner];
                let message = `å‹è€…: ${winnerPlayer.name}!`;
                messageBoxEl.innerHTML = `<h2>æ±ºç€</h2><p>${message}</p>`; // ãƒªã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã¯çœç•¥
                messageBoxEl.style.display = 'block';
            }
        });
    }

    // Player1ãŒã‚¿ã‚¤ãƒãƒ¼ã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
    async function updateTimer(gameData) {
        if (gameData.status !== 'playing') return;

        let newTime = gameData.timer - (0.01 * gameData.timerSpeed);
        
        // GCDã‚‚ã‚µãƒ¼ãƒãƒ¼å´ã§æ›´æ–°
        let player1Gcd = gameData.players['1'].gcd > 0 ? gameData.players['1'].gcd - 10 : 0;
        let player2Gcd = gameData.players['2']?.gcd > 0 ? gameData.players['2'].gcd - 10 : 0;

        const updates = {
            timer: newTime,
            'players.1.gcd': player1Gcd,
            'players.2.gcd': player2Gcd,
        };

        if (newTime <= 0) {
            updates.timer = 0;
            updates.isSignalActive = true;
            updates.status = 'finished'; // éŠƒè¡¨ç¤ºã¨åŒæ™‚ã«çµ‚äº†åˆ¤å®šã«ã™ã‚‹
            updates.winner = Math.random() < 0.5 ? 1 : 2; // ä»®ã®å‹è€…åˆ¤å®š
            if(localGameState.timerInterval) clearInterval(localGameState.timerInterval);
        }
        await updateDoc(doc(db, "games", localGameState.gameId), updates);
    }

    // --- ã‚¹ãƒ†ãƒƒãƒ—7: ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ã®å¤‰æ›´ ---
    
    // ã‚«ãƒ¼ãƒ‰ã‚’ä½¿ç”¨ã™ã‚‹ (Firestoreã‚’æ›´æ–°)
    async function useCard(cardIndex) {
        const gameRef = doc(db, "games", localGameState.gameId);
        const gameSnap = await getDoc(gameRef);
        if (!gameSnap.exists()) return;
        
        let gameData = gameSnap.data();
        const myPlayerId = localGameState.playerId.toString();
        const opponentPlayerId = myPlayerId === '1' ? '2' : '1';
        
        const me = gameData.players[myPlayerId];
        if (me.gcd > 0) return; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ä¸­

        const card = me.hand[cardIndex];
        if (!card) return;
        
        // ã‚«ãƒ¼ãƒ‰åŠ¹æœã‚’é©ç”¨ã—ã¦æ–°ã—ã„ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’è¨ˆç®—
        // (æ³¨æ„: ã“ã®éƒ¨åˆ†ã¯è¤‡é›‘ã«ãªã‚‹ãŸã‚ã€ä¸€éƒ¨ã®åŠ¹æœã®ã¿å®Ÿè£…)
        switch(card.name) {
            case "è·³èº": gameData.timer -= 2; break;
            case "å›å¸°": gameData.timer += 1.5; break;
            case "æŸç¸›": 
                if(gameData.players[opponentPlayerId]) {
                    gameData.players[opponentPlayerId].gcd = Math.max(gameData.players[opponentPlayerId].gcd, 2000);
                    gameData.players[opponentPlayerId].maxGcd = Math.max(gameData.players[opponentPlayerId].maxGcd, 2000);
                }
                break;
        }

        me.gcd = card.gcd * 1000;
        me.maxGcd = card.gcd * 1000;
        
        // ã‚«ãƒ¼ãƒ‰ã‚’å±±æœ­ã«æˆ»ã—ã€æ–°ã—ã„ã‚«ãƒ¼ãƒ‰ã‚’å¼•ã
        me.deck.push(me.hand.splice(cardIndex, 1)[0]);
        if (me.deck.length > 0) {
            me.deck.sort(() => Math.random() - 0.5);
            me.hand.push(me.deck.pop());
        }
        
        // Firestoreã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        await updateDoc(gameRef, gameData);
    }
    
    // éŠƒã‚’æ’ƒã¤ã‚¢ã‚¯ã‚·ãƒ§ãƒ³
    async function shoot() {
        const gameRef = doc(db, "games", localGameState.gameId);
        const gameSnap = await getDoc(gameRef);
        if (!gameSnap.exists()) return;
        const gameData = gameSnap.data();

        if (gameData.status === 'finished' || gameData.winner) return; // æ—¢ã«æ±ºç€æ¸ˆã¿

        if (gameData.isSignalActive) {
            // æ­£ã—ã„ã‚¿ã‚¤ãƒŸãƒ³ã‚° -> å‹ã¡
            await updateDoc(gameRef, { status: 'finished', winner: localGameState.playerId });
        } else {
            // ãŠæ‰‹ã¤ã -> è² ã‘
            const opponentPlayerId = localGameState.playerId === 1 ? 2 : 1;
            await updateDoc(gameRef, { status: 'finished', winner: opponentPlayerId });
        }
    }


    // --- UIæ›´æ–° (Firestoreã®ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ã„ã¦æç”») ---
    function updateUI(gameData) {
        if (!gameData) return;
        
        // ã‚¿ã‚¤ãƒãƒ¼
        timerEl.textContent = Math.max(0, gameData.timer).toFixed(2);
        timerEl.style.color = gameData.timer < 3 ? 'var(--secondary-color)' : 'var(--primary-color)';
        
        // éŠƒ
        gunEl.classList.toggle('active', gameData.isSignalActive);

        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼æƒ…å ±
        const myPlayerId = localGameState.playerId?.toString();
        const opponentPlayerId = myPlayerId === '1' ? '2' : '1';

        const me = gameData.players[myPlayerId];
        const opponent = gameData.players[opponentPlayerId];

        if (me) {
            updatePlayerUI(1, me, true);
        }
        if (opponent) {
            updatePlayerUI(2, opponent, false);
        } else {
            // ç›¸æ‰‹ãŒã¾ã ã„ãªã„å ´åˆ
            document.getElementById('player2-name').textContent = "(å‚åŠ å¾…...)";
            document.getElementById('hand-2').innerHTML = '';
        }
    }
    
    function updatePlayerUI(playerNum, playerData, isMe) {
        document.getElementById(`player${playerNum}-name`).textContent = playerData.name;
        document.getElementById(`deck-count-${playerNum}`).textContent = `å±±æœ­: ${playerData.deck.length}`;
        const handEl = document.getElementById(`hand-${playerNum}`);
        handEl.innerHTML = '';

        playerData.hand.forEach((card, index) => {
            const cardDiv = document.createElement('div');
            cardDiv.classList.add('card');
            const isDisabled = isMe && playerData.gcd > 0;
            if (isDisabled) cardDiv.classList.add('disabled');
            
            cardDiv.innerHTML = `
                ${isMe ? `<div class="card-key-hint">${index + 1}</div>` : ''}
                <div class="card-name">${card.name}</div>
                <div class="card-desc">${card.desc}</div>
                <div class="card-info">GCD: ${card.gcd}s</div>
            `;
            if (isMe && !isDisabled) {
                cardDiv.onclick = () => useCard(index);
            }
            handEl.appendChild(cardDiv);
        });
        
        const cooldownProgressEl = document.getElementById(`cooldown-progress-${playerNum}`);
        const gcdPercentage = playerData.maxGcd > 0 ? (playerData.gcd / playerData.maxGcd) * 100 : 0;
        cooldownProgressEl.style.width = `${gcdPercentage}%`;
    }
    
    // --- ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•° ---
    function createDeck() {
        let deck = [];
        for (let i = 0; i < 10; i++) {
            deck.push({...allCards[Math.floor(Math.random() * allCards.length)]});
        }
        return deck;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            lobbyStatus.textContent = `ID "${text}" ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼`;
        });
    }

    // --- ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ ---
    gunEl.addEventListener('click', shoot);
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' || e.code === 'Enter') { e.preventDefault(); shoot(); }
        if (e.code === 'Digit1') useCard(0);
        if (e.code === 'Digit2') useCard(1);
        if (e.code === 'Digit3') useCard(2);
    });

</script>
</body>
</html>
