<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Count and Nobles (Online)</title>
    <style>
        /* CSS„ÅØAIÂØæÊà¶Áâà„Åã„ÇâÂ§âÊõ¥„ÅÇ„Çä„Åæ„Åõ„Çì„Åå„ÄÅ„É≠„Éì„ÉºÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´„ÇíËøΩÂä†„Åó„Å¶„ÅÑ„Åæ„Åô */
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Orbitron:wght@400;700&display=swap');
        :root {
            --bg-color: #1a1a1a; --text-color: #e0e0e0; --primary-color: #d4af37;
            --secondary-color: #4a0e0e; --card-bg: #2c2c2c; --card-border: #444;
            --font-main: 'Noto Serif JP', serif; --font-timer: 'Orbitron', sans-serif;
        }
        body { background-color: var(--bg-color); color: var(--text-color); font-family: var(--font-main); display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        .container { width: 95%; max-width: 1200px; height: 95vh; border: 2px solid var(--primary-color); border-radius: 15px; background: rgba(0, 0, 0, 0.3); backdrop-filter: blur(10px); box-shadow: 0 0 30px rgba(212, 175, 55, 0.5); }
        
        /* --- „É≠„Éì„Éº„Çπ„Çø„Ç§„É´ --- */
        #lobby { padding: 40px; text-align: center; }
        #lobby h1 { font-size: 3rem; color: var(--primary-color); }
        #lobby p { font-size: 1.2rem; margin: 20px 0; }
        .lobby-actions button, .lobby-actions input { font-family: var(--font-main); font-size: 1.2rem; padding: 10px 20px; margin: 10px; border-radius: 8px; border: 2px solid var(--primary-color); background-color: transparent; color: var(--primary-color); cursor: pointer; transition: all 0.3s; }
        .lobby-actions button:hover { background-color: var(--primary-color); color: var(--bg-color); }
        .lobby-actions input { text-align: center; color: var(--text-color); }
        #game-id-display { margin-top: 30px; font-size: 1.5rem; }
        #game-id-display span { font-family: var(--font-timer); background: #000; padding: 5px 15px; border-radius: 5px; cursor: pointer; }

        /* --- „Ç≤„Éº„É†ÁîªÈù¢„Çπ„Çø„Ç§„É´ (AIÁâà„Å®ÂêåÊßò) --- */
        .game-container { width: 100%; height: 100%; display: flex; flex-direction: column; }
        .top-area { flex: 1; display: flex; justify-content: center; align-items: center; position: relative; }
        .timer-container { text-align: center; }
        #timer { font-family: var(--font-timer); font-size: clamp(4rem, 15vw, 8rem); color: var(--primary-color); text-shadow: 0 0 15px var(--primary-color); transition: all 0.2s ease; }
        .gun-area { position: absolute; font-size: 5rem; opacity: 0; transition: opacity 0.5s ease; cursor: pointer; filter: drop-shadow(0 0 10px #fff); }
        .gun-area.active { opacity: 1; }
        
        /* --- ‚òÖÂ§âÊõ¥ÁÇπ: „Ç≤„Éº„É†ÂÜÖ„É´„Éº„É†IDË°®Á§∫„ÅÆ„Çπ„Çø„Ç§„É´ --- */
        .room-id-ingame { position: absolute; top: 20px; right: 25px; font-family: var(--font-timer); font-size: 1.2rem; color: var(--text-color); opacity: 0.6; }

        #message-box { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(0, 0, 0, 0.85); padding: 30px 50px; border: 2px solid var(--primary-color); border-radius: 10px; text-align: center; z-index: 100; font-size: 2rem; box-shadow: 0 0 20px rgba(0,0,0,0.7); }
        #message-box h2 { margin: 0 0 15px 0; color: var(--primary-color); }
        #restart-button { margin-top: 20px; padding: 10px 20px; font-size: 1rem; cursor: pointer; background-color: var(--primary-color); color: var(--bg-color); border: none; border-radius: 5px; font-family: var(--font-main); font-weight: bold; transition: all 0.3s ease; }
        .players-area { display: flex; justify-content: space-between; padding: 20px; gap: 20px; }
        .player-container { flex: 1; display: flex; flex-direction: column; border: 1px solid var(--card-border); border-radius: 10px; padding: 15px; background: rgba(44, 44, 44, 0.5); }
        .player-info { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .player-name { font-size: 1.5rem; font-weight: bold; }
        .deck-info { font-size: 1.2rem; }
        .cooldown-bar { width: 100%; height: 5px; background-color: #444; border-radius: 5px; margin-top: 10px; overflow: hidden; }
        .cooldown-progress { width: 100%; height: 100%; background-color: var(--primary-color); transition: width 0.1s linear; }
        .hand { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; min-height: 180px; }
        .card { background-color: var(--card-bg); border: 1px solid var(--card-border); border-radius: 10px; padding: 10px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: all 0.3s ease; position: relative; }
        .card:hover { transform: translateY(-10px) scale(1.05); box-shadow: 0 10px 20px rgba(0,0,0,0.5); border-color: var(--primary-color); }
        .card.disabled { cursor: not-allowed; opacity: 0.5; filter: grayscale(80%); }
        .card-name { font-weight: bold; font-size: 1rem; color: var(--primary-color); padding-top: 15px; }
        .card-desc { font-size: 0.8rem; flex-grow: 1; margin-top: 5px; }
        .card-info { font-size: 0.7rem; text-align: right; opacity: 0.7; }
        .card-key-hint { position: absolute; top: 5px; left: 10px; font-size: 1.2rem; font-weight: bold; font-family: var(--font-timer); color: rgba(255, 255, 255, 0.4); }
    </style>
</head>
<body>

<div class="container">
    <!-- „É≠„Éì„ÉºÁîªÈù¢ -->
    <div id="lobby">
        <h1>Count and Nobles</h1>
        <p>„Ç™„É≥„É©„Ç§„É≥„ÅßÂØæÊà¶„Åô„Çã</p>
        <div class="lobby-actions">
            <button id="create-game-btn">„É´„Éº„É†„Çí‰ΩúÊàê</button>
            <input type="text" id="join-game-input" placeholder="„É´„Éº„É†ID„ÇíÂÖ•Âäõ">
            <button id="join-game-btn">„É´„Éº„É†„Å´ÂèÇÂä†</button>
        </div>
        <div id="game-id-display"></div>
        <p id="lobby-status"></p>
    </div>

    <!-- „Ç≤„Éº„É†ÁîªÈù¢ (ÊúÄÂàù„ÅØÈùûË°®Á§∫) -->
    <div id="game-container" class="game-container" style="display: none;">
        <div class="top-area">
            <!-- ‚òÖÂ§âÊõ¥ÁÇπ: „Ç≤„Éº„É†ÂÜÖ„É´„Éº„É†IDË°®Á§∫Áî®„ÅÆË¶ÅÁ¥†„ÇíËøΩÂä† -->
            <div id="room-id-ingame" class="room-id-ingame"></div>
            <div class="timer-container">
                <div id="timer">10.00</div>
            </div>
            <div id="gun" class="gun-area">üî´</div>
        </div>
        <div id="message-box" style="display: none;"></div>
        <div class="players-area">
            <div class="player-container" id="player1-container">
                <div class="player-info">
                    <span class="player-name" id="player1-name">Player 1</span>
                    <span class="deck-info" id="deck-count-1">Deck: 10</span>
                </div>
                <div class="hand" id="hand-1"></div>
                <div class="cooldown-bar"><div class="cooldown-progress" id="cooldown-progress-1"></div></div>
            </div>
            <div class="player-container" id="player2-container">
                <div class="player-info">
                    <span class="player-name" id="player2-name">Player 2</span>
                    <span class="deck-info" id="deck-count-2">Deck: 10</span>
                </div>
                <div class="hand" id="hand-2"></div>
                <div class="cooldown-bar"><div class="cooldown-progress" id="cooldown-progress-2"></div></div>
            </div>
        </div>
    </div>
</div>

<script type="module">
    // Firebase SDK„Çí„Ç§„É≥„Éù„Éº„Éà„Åó„Åæ„Åô
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, setDoc, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- „Åì„Åì„Å´„ÄÅ„ÅÇ„Å™„Åü„ÅÆfirebaseConfig„ÇíË≤º„Çä‰ªò„Åë„Åæ„Åô ---
    const firebaseConfig = {
      apiKey: "AIzaSyBR4AcKo_D26DHF8zeHlW6KBSge6nPEYvw",
      authDomain: "count-and-nobles-test.firebaseapp.com",
      projectId: "count-and-nobles-test",
      storageBucket: "count-and-nobles-test.appspot.com",
      messagingSenderId: "944479168462",
      appId: "1:944479168462:web:ffa8c678d0f3a729b5ad9f"
    };
    // --------------------------------------------------------------------

    // Firebase„ÅÆÂàùÊúüÂåñ
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- DOM Elements ---
    const lobbyEl = document.getElementById('lobby');
    const gameContainerEl = document.getElementById('game-container');
    const createGameBtn = document.getElementById('create-game-btn');
    const joinGameBtn = document.getElementById('join-game-btn');
    const joinGameInput = document.getElementById('join-game-input');
    const gameIdDisplay = document.getElementById('game-id-display');
    const lobbyStatus = document.getElementById('lobby-status');
    const timerEl = document.getElementById('timer');
    const gunEl = document.getElementById('gun');
    const messageBoxEl = document.getElementById('message-box');
    // ‚òÖÂ§âÊõ¥ÁÇπ: „Ç≤„Éº„É†ÂÜÖ„É´„Éº„É†IDË°®Á§∫Áî®„ÅÆË¶ÅÁ¥†„ÇíÂèñÂæó
    const roomIdIngameEl = document.getElementById('room-id-ingame');

    // --- Game State („É≠„Éº„Ç´„É´) ---
    let localGameState = {
        gameId: null,
        playerId: null, // 1 or 2
        unsubscribe: null, // „É™„Ç¢„É´„Çø„Ç§„É†Áõ£Ë¶ñ„ÇíÂÅúÊ≠¢„Åô„Çã„Åü„ÇÅ„ÅÆÈñ¢Êï∞
        timerInterval: null,
    };
    
    // --- „Ç´„Éº„ÉâÂÆöÁæ© ---
    const allCards = [
        { id: 1, name: "Âä†ÈÄü", desc: "2ÁßíÈñì„ÄÅÊôÇÈñì„ÅÆÊµÅ„Çå„Åå2ÂÄç„Å´„Å™„Çã„ÄÇ", type: "time", gcd: 3 },
        { id: 2, name: "Ê∏õÈÄü", desc: "3ÁßíÈñì„ÄÅÊôÇÈñì„ÅÆÊµÅ„Çå„ÅåÂçäÂàÜ„Å´„Å™„Çã„ÄÇ", type: "time", gcd: 4 },
        { id: 3, name: "Ë∑≥Ë∫ç", desc: "ÊôÇÈñì„Çí2ÁßíÈÄ≤„ÇÅ„Çã„ÄÇ", type: "time", gcd: 2 },
        { id: 4, name: "ÂõûÂ∏∞", desc: "ÊôÇÈñì„Çí1.5ÁßíÊàª„Åô„ÄÇ", type: "time", gcd: 3 },
        { id: 5, name: "ÂπªÊÉë", desc: "2ÁßíÈñì„Çø„Ç§„Éû„Éº„ÇíÈö†„Åô„ÄÇ", type: "meta", gcd: 5 },
        { id: 6, name: "ÂÅΩ„Çä„ÅÆÂêàÂõ≥", desc: "„É©„É≥„ÉÄ„É†„Å™„Çø„Ç§„Éü„É≥„Ç∞„ÅßÂÅΩ„ÅÆÈäÉ„ÇíÂá∫Áèæ„Åï„Åõ„Çã„ÄÇ", type: "meta", gcd: 4 },
        { id: 7, name: "ÊùüÁ∏õ", desc: "Áõ∏Êâã„ÅØ2ÁßíÈñì„Ç´„Éº„Éâ„Çí‰Ωø„Åà„Å™„ÅÑ„ÄÇ", type: "special", gcd: 5 },
        { id: 8, name: "ÊâãÊú≠‰∫§Êèõ", desc: "Ëá™ÂàÜ„ÅÆÊâãÊú≠„ÇíÂÖ®„Å¶‰∫§Êèõ„Åô„Çã„ÄÇ", type: "special", gcd: 2 },
    ];

    // --- „É≠„Éì„ÉºÊ©üËÉΩ ---
    createGameBtn.onclick = async () => {
        lobbyStatus.textContent = "„É´„Éº„É†„Çí‰ΩúÊàê‰∏≠...";
        const gameId = Math.random().toString(36).substring(2, 7).toUpperCase();
        localGameState.gameId = gameId;
        localGameState.playerId = 1;

        const initialDeck = createDeck();
        const initialHand = [];
        for(let i=0; i<3; i++) initialHand.push(initialDeck.pop());

        const gameData = {
            status: 'waiting', timer: 10, timerSpeed: 1, isSignalActive: false, winner: null,
            players: {
                '1': { name: 'Player 1', deck: initialDeck, hand: initialHand, gcd: 0, maxGcd: 0 },
                '2': null
            }
        };

        try {
            await setDoc(doc(db, "games", gameId), gameData);
            gameIdDisplay.innerHTML = `„É´„Éº„É†ID: <span id="game-id-span">${gameId}</span> („ÇØ„É™„ÉÉ„ÇØ„Åó„Å¶„Ç≥„Éî„Éº)`;
            document.getElementById('game-id-span').onclick = () => copyToClipboard(gameId);
            lobbyStatus.textContent = "„Éó„É¨„Ç§„É§„Éº2„ÅÆÂèÇÂä†„ÇíÂæÖ„Å£„Å¶„ÅÑ„Åæ„Åô...";
            listenToGameUpdates(gameId);
        } catch (e) {
            console.error("Error creating game: ", e);
            lobbyStatus.textContent = "„É´„Éº„É†„ÅÆ‰ΩúÊàê„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇFirestore„ÅÆ„É´„Éº„É´„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ";
        }
    };

    joinGameBtn.onclick = async () => {
        const gameId = joinGameInput.value.toUpperCase();
        if (!gameId) { lobbyStatus.textContent = "„É´„Éº„É†ID„ÇíÂÖ•Âäõ„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ"; return; }
        lobbyStatus.textContent = "„É´„Éº„É†„Å´ÂèÇÂä†‰∏≠...";
        const gameRef = doc(db, "games", gameId);
        const gameSnap = await getDoc(gameRef);

        if (gameSnap.exists()) {
            const gameData = gameSnap.data();
            if (gameData.players['2']) { lobbyStatus.textContent = "„Åì„ÅÆ„É´„Éº„É†„ÅØÊ∫ÄÂì°„Åß„Åô„ÄÇ"; return; }
            
            localGameState.gameId = gameId;
            localGameState.playerId = 2;
            const initialDeck = createDeck();
            const initialHand = [];
            for(let i=0; i<3; i++) initialHand.push(initialDeck.pop());

            await updateDoc(gameRef, {
                'players.2': { name: 'Player 2', deck: initialDeck, hand: initialHand, gcd: 0, maxGcd: 0 },
                status: 'playing'
            });
            listenToGameUpdates(gameId);
        } else {
            lobbyStatus.textContent = "ÊåáÂÆö„Åï„Çå„ÅüID„ÅÆ„É´„Éº„É†„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ";
        }
    };

    // --- „É™„Ç¢„É´„Çø„Ç§„É†ÂêåÊúü ---
    function listenToGameUpdates(gameId) {
        lobbyEl.style.display = 'none';
        gameContainerEl.style.display = 'flex';

        localGameState.unsubscribe = onSnapshot(doc(db, "games", gameId), (docSnap) => {
            if (!docSnap.exists()) return;
            const gameData = docSnap.data();
            updateUI(gameData);

            if (gameData.status === 'playing' && localGameState.playerId === 1 && !localGameState.timerInterval) {
                localGameState.timerInterval = setInterval(() => {
                    getDoc(doc(db, "games", gameId)).then(snap => {
                        if (snap.exists()) updateTimer(snap.data());
                    });
                }, 10);
            }
            
            if (gameData.status === 'finished') {
                if(localGameState.timerInterval) {
                    clearInterval(localGameState.timerInterval);
                    localGameState.timerInterval = null;
                }
                const winnerPlayer = gameData.players[gameData.winner];
                if (winnerPlayer) {
                    let message = `ÂãùËÄÖ: ${winnerPlayer.name}!`;
                    messageBoxEl.innerHTML = `<h2>Ê±∫ÁùÄ</h2><p>${message}</p>`;
                    messageBoxEl.style.display = 'block';
                }
            }
        });
    }

    async function updateTimer(gameData) {
        if (gameData.status !== 'playing') {
            if(localGameState.timerInterval) clearInterval(localGameState.timerInterval);
            localGameState.timerInterval = null;
            return;
        }

        let newTime = gameData.timer - (0.01 * gameData.timerSpeed);
        let player1Gcd = gameData.players['1'].gcd > 0 ? gameData.players['1'].gcd - 10 : 0;
        let player2Gcd = gameData.players['2']?.gcd > 0 ? gameData.players['2'].gcd - 10 : 0;

        const updates = { 'players.1.gcd': player1Gcd, 'players.2.gcd': player2Gcd };

        if (newTime > 0) {
            updates.timer = newTime;
        } else if (!gameData.isSignalActive) {
            updates.timer = 0;
            updates.isSignalActive = true;
            if(localGameState.timerInterval) clearInterval(localGameState.timerInterval);
            localGameState.timerInterval = null;
        }
        
        if (Object.keys(updates).length > 0) {
            await updateDoc(doc(db, "games", localGameState.gameId), updates);
        }
    }

    // --- „Éó„É¨„Ç§„É§„Éº„Ç¢„ÇØ„Ç∑„Éß„É≥ ---
    async function useCard(cardIndex) {
        const gameRef = doc(db, "games", localGameState.gameId);
        const gameSnap = await getDoc(gameRef);
        if (!gameSnap.exists()) return;
        
        let gameData = gameSnap.data();
        const myPlayerId = localGameState.playerId.toString();
        const opponentPlayerId = myPlayerId === '1' ? '2' : '1';
        const me = gameData.players[myPlayerId];

        if (me.gcd > 0 || gameData.status !== 'playing') return;
        const card = me.hand[cardIndex];
        if (!card) return;
        
        switch(card.name) {
            case "Ë∑≥Ë∫ç": gameData.timer -= 2; break;
            case "ÂõûÂ∏∞": gameData.timer += 1.5; break;
            case "ÊùüÁ∏õ": 
                if(gameData.players[opponentPlayerId]) {
                    gameData.players[opponentPlayerId].gcd = Math.max(gameData.players[opponentPlayerId].gcd, 2000);
                    gameData.players[opponentPlayerId].maxGcd = Math.max(gameData.players[opponentPlayerId].maxGcd, 2000);
                }
                break;
        }

        me.gcd = card.gcd * 1000;
        me.maxGcd = card.gcd * 1000;
        
        me.deck.push(me.hand.splice(cardIndex, 1)[0]);
        if (me.deck.length > 0) {
            me.deck.sort(() => Math.random() - 0.5);
            me.hand.push(me.deck.pop());
        }
        
        await updateDoc(gameRef, gameData);
    }
    
    async function shoot() {
        const gameRef = doc(db, "games", localGameState.gameId);
        const gameSnap = await getDoc(gameRef);
        if (!gameSnap.exists()) return;
        const gameData = gameSnap.data();

        if (gameData.status === 'finished' || gameData.winner) return;

        if (gameData.isSignalActive) {
            await updateDoc(gameRef, { status: 'finished', winner: localGameState.playerId });
        } else {
            const opponentPlayerId = localGameState.playerId === 1 ? 2 : 1;
            await updateDoc(gameRef, { status: 'finished', winner: opponentPlayerId });
        }
    }

    // --- UIÊõ¥Êñ∞ ---
    function updateUI(gameData) {
        if (!gameData) return;
        
        // ‚òÖÂ§âÊõ¥ÁÇπ: „Ç≤„Éº„É†ÂÜÖ„É´„Éº„É†ID„ÇíË°®Á§∫
        if(localGameState.gameId) {
            roomIdIngameEl.textContent = `ID: ${localGameState.gameId}`;
        }

        timerEl.textContent = Math.max(0, gameData.timer).toFixed(2);
        timerEl.style.color = gameData.timer < 3 ? 'var(--secondary-color)' : 'var(--primary-color)';
        gunEl.classList.toggle('active', gameData.isSignalActive);

        const myPlayerId = localGameState.playerId?.toString();
        const opponentPlayerId = myPlayerId === '1' ? '2' : '1';
        const me = gameData.players[myPlayerId];
        const opponent = gameData.players[opponentPlayerId];

        if (me) updatePlayerUI(1, me, true);
        if (opponent) {
            updatePlayerUI(2, opponent, false);
        } else {
            document.getElementById('player2-name').textContent = "(ÂèÇÂä†ÂæÖ...)";
            document.getElementById('hand-2').innerHTML = '';
        }
    }
    
    function updatePlayerUI(playerNum, playerData, isMe) {
        document.getElementById(`player${playerNum}-name`).textContent = playerData.name;
        document.getElementById(`deck-count-${playerNum}`).textContent = `Â±±Êú≠: ${playerData.deck.length}`;
        const handEl = document.getElementById(`hand-${playerNum}`);
        handEl.innerHTML = '';

        playerData.hand.forEach((card, index) => {
            const cardDiv = document.createElement('div');
            cardDiv.classList.add('card');
            const isDisabled = isMe && playerData.gcd > 0;
            if (isDisabled) cardDiv.classList.add('disabled');
            
            cardDiv.innerHTML = `
                ${isMe ? `<div class="card-key-hint">${index + 1}</div>` : ''}
                <div class="card-name">${card.name}</div>
                <div class="card-desc">${card.desc}</div>
                <div class="card-info">GCD: ${card.gcd}s</div>
            `;
            if (isMe && !isDisabled) {
                cardDiv.onclick = () => useCard(index);
            }
            handEl.appendChild(cardDiv);
        });
        
        const cooldownProgressEl = document.getElementById(`cooldown-progress-${playerNum}`);
        const gcdPercentage = playerData.maxGcd > 0 ? (playerData.gcd / playerData.maxGcd) * 100 : 0;
        cooldownProgressEl.style.width = `${gcdPercentage}%`;
    }
    
    // --- „Éò„É´„Éë„ÉºÈñ¢Êï∞ ---
    function createDeck() {
        let deck = [];
        for (let i = 0; i < 10; i++) {
            deck.push({...allCards[Math.floor(Math.random() * allCards.length)]});
        }
        return deck;
    }

    function copyToClipboard(text) {
        navigator.clipboard.writeText(text).then(() => {
            lobbyStatus.textContent = `ID "${text}" „Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„ÅüÔºÅ`;
        });
    }

    // --- „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº ---
    gunEl.addEventListener('click', shoot);
    document.addEventListener('keydown', (e) => {
        if (e.code === 'Space' || e.code === 'Enter') { e.preventDefault(); shoot(); }
        if (e.code === 'Digit1') useCard(0);
        if (e.code === 'Digit2') useCard(1);
        if (e.code === 'Digit3') useCard(2);
    });

</script>
</body>
</html>
